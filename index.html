<!DOCTYPE html>
<html lang="gl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora Nómina Vicusgraf — Forzar uso de táboas</title>
<style>
:root{--bg:#f3f8f4;--verde-esc:#1f3b2c;--verde-med:#2d5c42;--muted:#486854;}
html,body{height:100%;margin:0;font-family: "Segoe UI", Arial, sans-serif;background:var(--bg);color:var(--verde-esc);}
.container{max-width:980px;margin:18px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.06);}
h1{margin:0 0 12px 0;font-size:1.2rem;}
label{display:block;margin-top:12px;font-weight:600;}
input[type="text"], input[type="number"], select {width:100%;padding:10px;border-radius:8px;border:1px solid #dfeee0;background:#f7fbf8;font-size:1rem;box-sizing:border-box;}
.checkbox-inline{display:flex;align-items:center;gap:8px;margin-top:10px;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.btn{padding:10px 14px;border-radius:10px;border:0;background:#2d5c42;color:#fff;font-weight:700;cursor:pointer;margin-top:12px;}
.summary{background:#f6fbf7;padding:12px;border-radius:8px;border:1px solid #e6f1ea;margin-top:12px;}
.small{font-size:.9rem;color:var(--muted);}
@media (max-width:720px){ .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>
  <div class="container" role="application" aria-label="Calculadora Nómina Vicusgraf — Forzar táboas">
    <h1>Calculadora Nómina — Forzar uso de táboas do convenio</h1>

    <p class="small">Esta versión usa sempre as táboas oficiais do convenio para obter o <strong>módulo anual</strong> (salario base + complemento ex‑categoría) e aplica a regra do artigo 7.3.5 para o complemento de antigüidade.</p>

    <div class="grid">
      <div>
        <label>Mes</label>
        <select id="mes"><option value="">—</option></select>
      </div>
      <div>
        <label>Ano</label>
        <select id="ano"><option value="">—</option></select>
      </div>
    </div>

    <label>Nivel salarial</label>
    <select id="nivel"><option value="">—</option></select>

    <label>Data de ingreso (dd/mm/aaaa)</label>
    <input type="text" id="dataIngreso" placeholder="dd/mm/aaaa" inputmode="numeric">

    <label>% IRPF</label>
    <input type="number" id="irpf" step="0.1" placeholder="Ex.: 15">

    <label class="checkbox-inline"><input type="checkbox" id="prorrata"> Pagas extra prorrateadas</label>

    <div>
      <button id="calcularBtn" class="btn">Calcular resumo</button>
    </div>

    <div id="resumo" class="summary" aria-live="polite" style="display:none;"></div>
  </div>

<script>
/* ---------- Táboas do convenio (2023-2025) ---------- */
const tablas = {
  2023: {
    1:{salarioBase:24995.71,lineal:4886.16,pagaVeran:2054.44,pagaNadal:2054.44,pagaMarzo:2328.37,smi:0},
    2:{salarioBase:19868.39,lineal:4886.16,pagaVeran:1633.02,pagaNadal:1633.02,pagaMarzo:1850.75,smi:0},
    3:{salarioBase:19227.48,lineal:4886.16,pagaVeran:1580.34,pagaNadal:1580.34,pagaMarzo:1791.05,smi:0},
    4:{salarioBase:17945.63,lineal:4886.16,pagaVeran:1474.98,pagaNadal:1474.98,pagaMarzo:1671.65,smi:0},
    5:{salarioBase:16663.83,lineal:4886.16,pagaVeran:1369.63,pagaNadal:1369.63,pagaMarzo:1552.25,smi:0},
    6:{salarioBase:15381.98,lineal:4886.16,pagaVeran:1264.27,pagaNadal:1264.27,pagaMarzo:1432.84,smi:0},
    7:{salarioBase:14741.07,lineal:4886.16,pagaVeran:1211.59,pagaNadal:1211.59,pagaMarzo:1373.14,smi:0},
    8:{salarioBase:14100.15,lineal:4886.16,pagaVeran:1158.92,pagaNadal:1158.92,pagaMarzo:1313.44,smi:0},
    9:{salarioBase:13459.23,lineal:4886.16,pagaVeran:1106.24,pagaNadal:1106.24,pagaMarzo:1253.74,smi:0},
    10:{salarioBase:12818.32,lineal:4886.16,pagaVeran:1053.56,pagaNadal:1053.56,pagaMarzo:1194.04,smi:0},
    11:{salarioBase:12177.41,lineal:4886.16,pagaVeran:1000.88,pagaNadal:1000.88,pagaMarzo:1134.33,smi:0},
    12:{salarioBase:11536.49,lineal:4886.16,pagaVeran:948.20,pagaNadal:948.20,pagaMarzo:1074.63,smi:0},
    13:{salarioBase:10895.56,lineal:4886.16,pagaVeran:895.53,pagaNadal:895.53,pagaMarzo:1014.93,smi:0},
    14:{salarioBase:10446.94,lineal:4886.16,pagaVeran:858.65,pagaNadal:858.65,pagaMarzo:973.14,smi:0},
    15:{salarioBase:9934.20,lineal:4886.16,pagaVeran:816.51,pagaNadal:816.51,pagaMarzo:925.38,smi:0},
    16:{salarioBase:9421.46,lineal:4886.16,pagaVeran:774.37,pagaNadal:774.37,pagaMarzo:877.62,smi:0},
    17:{salarioBase:8972.83,lineal:4886.16,pagaVeran:737.49,pagaNadal:737.49,pagaMarzo:835.83,smi:0},
    18:{salarioBase:8588.28,lineal:4886.16,pagaVeran:705.89,pagaNadal:705.89,pagaMarzo:800.00,smi:0},
    19:{salarioBase:8203.72,lineal:4886.16,pagaVeran:674.28,pagaNadal:674.28,pagaMarzo:764.18,smi:0}
  },
  2024: {
    1:{salarioBase:25808.07,lineal:5044.96,pagaVeran:2121.21,pagaNadal:2121.21,pagaMarzo:2404.04,smi:0},
    2:{salarioBase:20514.11,lineal:5044.96,pagaVeran:1686.09,pagaNadal:1686.09,pagaMarzo:1910.90,smi:0},
    3:{salarioBase:19852.37,lineal:5044.96,pagaVeran:1631.70,pagaNadal:1631.70,pagaMarzo:1849.26,smi:0},
    4:{salarioBase:18528.86,lineal:5044.96,pagaVeran:1522.92,pagaNadal:1522.92,pagaMarzo:1725.98,smi:0},
    5:{salarioBase:17205.40,lineal:5044.96,pagaVeran:1414.14,pagaNadal:1414.14,pagaMarzo:1602.69,smi:0},
    6:{salarioBase:15881.89,lineal:5044.96,pagaVeran:1305.36,pagaNadal:1305.36,pagaMarzo:1479.41,smi:0},
    7:{salarioBase:15220.15,lineal:5044.96,pagaVeran:1250.97,pagaNadal:1250.97,pagaMarzo:1417.77,smi:0},
    8:{salarioBase:14558.40,lineal:5044.96,pagaVeran:1196.58,pagaNadal:1196.58,pagaMarzo:1356.12,smi:0},
    9:{salarioBase:13896.65,lineal:5044.96,pagaVeran:1142.19,pagaNadal:1142.19,pagaMarzo:1294.48,smi:0},
    10:{salarioBase:13234.92,lineal:5044.96,pagaVeran:1087.80,pagaNadal:1087.80,pagaMarzo:1232.84,smi:0},
    11:{salarioBase:12573.18,lineal:5044.96,pagaVeran:1033.41,pagaNadal:1033.41,pagaMarzo:1171.20,smi:0},
    12:{salarioBase:11911.43,lineal:5044.96,pagaVeran:979.02,pagaNadal:979.02,pagaMarzo:1109.56,smi:0},
    13:{salarioBase:11249.67,lineal:5044.96,pagaVeran:924.63,pagaNadal:924.63,pagaMarzo:1047.91,smi:0},
    14:{salarioBase:10786.47,lineal:5044.96,pagaVeran:886.56,pagaNadal:886.56,pagaMarzo:1004.77,smi:0},
    15:{salarioBase:10257.06,lineal:5044.96,pagaVeran:843.05,pagaNadal:843.05,pagaMarzo:955.45,smi:0},
    16:{salarioBase:9727.66,lineal:5044.96,pagaVeran:799.53,pagaNadal:799.53,pagaMarzo:906.14,smi:0},
    17:{salarioBase:9264.45,lineal:5044.96,pagaVeran:761.46,pagaNadal:761.46,pagaMarzo:862.99,smi:0},
    18:{salarioBase:8867.40,lineal:5044.96,pagaVeran:728.83,pagaNadal:728.83,pagaMarzo:826.00,smi:0},
    19:{salarioBase:8470.34,lineal:5044.96,pagaVeran:696.19,pagaNadal:696.19,pagaMarzo:789.02,smi:0}
  },
  2025: {
    1:{salarioBase:26582.31,lineal:5196.31,pagaVeran:2184.85,pagaNadal:2184.85,pagaMarzo:2476.16,smi:0},
    2:{salarioBase:21129.53,lineal:5196.31,pagaVeran:1736.67,pagaNadal:1736.67,pagaMarzo:1968.23,smi:0},
    3:{salarioBase:20447.94,lineal:5196.31,pagaVeran:1680.65,pagaNadal:1680.65,pagaMarzo:1904.74,smi:0},
    4:{salarioBase:19084.73,lineal:5196.31,pagaVeran:1568.61,pagaNadal:1568.61,pagaMarzo:1777.76,smi:0},
    5:{salarioBase:17721.55,lineal:5196.31,pagaVeran:1456.57,pagaNadal:1456.57,pagaMarzo:1650.77,smi:0},
    6:{salarioBase:16358.35,lineal:5196.31,pagaVeran:1344.52,pagaNadal:1344.52,pagaMarzo:1523.79,smi:0},
    7:{salarioBase:15676.78,lineal:5196.31,pagaVeran:1288.50,pagaNadal:1288.50,pagaMarzo:1460.30,smi:0},
    8:{salarioBase:14995.15,lineal:5196.31,pagaVeran:1232.48,pagaNadal:1232.48,pagaMarzo:1396.81,smi:0},
    9:{salarioBase:14313.57,lineal:5196.31,pagaVeran:1176.46,pagaNadal:1176.46,pagaMarzo:1333.32,smi:0},
    10:{salarioBase:13631.97,lineal:5196.31,pagaVeran:1120.44,pagaNadal:1120.44,pagaMarzo:1269.83,smi:0},
    11:{salarioBase:12950.37,lineal:5196.31,pagaVeran:1064.41,pagaNadal:1064.41,pagaMarzo:1206.34,smi:0},
    12:{salarioBase:12268.77,lineal:5196.31,pagaVeran:1008.39,pagaNadal:1008.39,pagaMarzo:1142.84,smi:0},
    13:{salarioBase:11587.16,lineal:5196.31,pagaVeran:952.37,pagaNadal:952.37,pagaMarzo:1079.35,smi:0},
    14:{salarioBase:11110.06,lineal:5196.31,pagaVeran:913.16,pagaNadal:913.16,pagaMarzo:1034.91,smi:0},
    15:{salarioBase:10564.77,lineal:5196.31,pagaVeran:868.34,pagaNadal:868.34,pagaMarzo:984.12,smi:0},
    16:{salarioBase:10019.49,lineal:5196.31,pagaVeran:823.52,pagaNadal:823.52,pagaMarzo:933.32,smi:0},
    17:{salarioBase:9542.38,lineal:5196.31,pagaVeran:784.31,pagaNadal:784.31,pagaMarzo:888.88,smi:0},
    18:{salarioBase:9133.42,lineal:5196.31,pagaVeran:750.69,pagaNadal:750.69,pagaMarzo:850.78,smi:0},
    19:{salarioBase:8724.45,lineal:5196.31,pagaVeran:717.08,pagaNadal:717.08,pagaMarzo:812.69,smi:408.39}
  }
};

/* ---------- Inicialización selects ---------- */
(function initSelects(){
  const mes = document.getElementById('mes');
  const ano = document.getElementById('ano');
  const nivel = document.getElementById('nivel');
  const meses = ['Xaneiro','Febreiro','Marzo','Abril','Maio','Xuño','Xullo','Agosto','Setembro','Outubro','Novembro','Decembro'];
  meses.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=m; mes.appendChild(o); });
  const anoActual = new Date().getFullYear();
  for(let a=anoActual-3;a<=anoActual+1;a++){ const o=document.createElement('option'); o.value=a; o.textContent=a; ano.appendChild(o); }
  for(let n=1;n<=19;n++){ const o=document.createElement('option'); o.value=n; o.textContent='Nivel '+n; nivel.appendChild(o); }
})();

/* ---------- Autoformat data ingreso ---------- */
(function(){
  const input = document.getElementById('dataIngreso');
  function digits(s){ return (s||'').replace(/\D/g,'').slice(0,8); }
  function fmt(raw){
    const d = digits(raw);
    if (d.length<=2) return d;
    if (d.length<=4) return d.slice(0,2)+'/'+d.slice(2);
    return d.slice(0,2)+'/'+d.slice(2,4)+'/'+d.slice(4);
  }
  input.addEventListener('input', ()=>{ input.value = fmt(input.value); });
  input.addEventListener('paste', (e)=>{ e.preventDefault(); const t=(e.clipboardData||window.clipboardData).getData('text'); input.value = fmt(t); });
})();

/* ---------- Antigüidade ---------- */
function calcularAntiguedadeDesdeInput(refDate=new Date()){
  const txt = (document.getElementById('dataIngreso').value||'').trim();
  if(!txt) return null;
  const p = txt.split('/');
  if(p.length!==3) return null;
  const d=parseInt(p[0],10), m=parseInt(p[1],10), a=parseInt(p[2],10);
  if(!d||!m||!a) return null;
  const ingreso = new Date(a,m-1,d);
  if(isNaN(ingreso.getTime())) return null;
  const min = new Date(2013,11,1);
  if(ingreso < min) return null;
  let years = refDate.getFullYear() - ingreso.getFullYear();
  let months = refDate.getMonth() - ingreso.getMonth();
  let days = refDate.getDate() - ingreso.getDate();
  if(days<0){ months -=1; const prev = new Date(refDate.getFullYear(), refDate.getMonth(), 0); days += prev.getDate(); }
  if(months<0){ years -=1; months +=12; }
  return { years, months, days, toString(){ const parts=[]; if(this.years) parts.push(this.years+' ano'+(this.years>1?'s':'')); if(this.months) parts.push(this.months+' mes'+(this.months>1?'es':'')); if(this.days) parts.push(this.days+' día'+(this.days>1?'s':'')); return parts.length?parts.join(', '):'0 días'; } };
}

/* ---------- Complemento antigüidade (7.3.5) usando sempre táboas ---------- */
function calcularComplementoAntiguedade_forzado(dados){
  const antig = calcularAntiguedadeDesdeInput();
  if(!antig || !dados || !dados.t) return null;
  const anos = antig.years;

  // unidades: 1ª aos 3, 2ª aos 6, a partir de 11 cada 5 anos +1
  let unidades = 0;
  if (anos >= 3 && anos < 6) unidades = 1;
  else if (anos >= 6 && anos < 11) unidades = 2;
  else if (anos >= 11) unidades = 2 + Math.floor((anos - 6) / 5);
  else unidades = 0;

  const trienios = Math.min(2, unidades);
  const quinquenios = Math.max(0, unidades - trienios);
  const totalPercent = unidades * 0.03; // 3% por unidade

  // Módulo anual: sempre tomado das táboas (salarioBase + lineal)
  const salarioBaseAnual = dados.t.salarioBase || 0;
  const complementoExCategoriaAnual = dados.t.lineal || 0;
  const moduloAnual = salarioBaseAnual + complementoExCategoriaAnual;
  const moduloMensual = moduloAnual / 12;
  const importeAnualAplicado = moduloAnual * totalPercent;
  const importeMensualAplicado = moduloMensual * totalPercent;

  return {
    trienios, quinquenios, unidades, totalPercent,
    salarioBaseAnual, complementoExCategoriaAnual,
    moduloAnual, moduloMensual, importeAnualAplicado, importeMensualAplicado
  };
}

/* ---------- Obter datos nivel/ano ---------- */
function obterDatosNivelAno(){
  const anoSel = parseInt(document.getElementById('ano').value||'0',10);
  const nivelSel = parseInt(document.getElementById('nivel').value||'0',10);
  if(!anoSel || !nivelSel) return null;
  const ref = (anoSel>=2026)?2025:anoSel;
  const tAno = tablas[ref];
  if(!tAno) return null;
  const t = tAno[nivelSel];
  if(!t) return null;
  return { anoSel:ref, nivelSel, t };
}

/* ---------- Evento calcular ---------- */
document.getElementById('calcularBtn').addEventListener('click', ()=>{
  const resumoEl = document.getElementById('resumo');
  resumoEl.style.display = 'block';
  resumoEl.innerHTML = '<p class="small">Calculando…</p>';

  const dados = obterDatosNivelAno();
  const antig = calcularAntiguedadeDesdeInput();
  if(!dados){ resumoEl.innerHTML = '<p style="color:#b33">Selecciona ano e nivel.</p>'; return; }
  if(!antig){ resumoEl.innerHTML = '<p style="color:#b33">Introduce unha data de ingreso válida (dd/mm/aaaa) posterior a 12/2013.</p>'; return; }

  const compAnt = calcularComplementoAntiguedade_forzado(dados);

  // salario mensual e lineal mensual (segundo táboas)
  const salarioMensual_tabla = dados.t.salarioBase / 12;
  const linealMensual_tabla = dados.t.lineal / 12;
  const complementoAntMensual = compAnt.importeMensualAplicado;

  // total devengos estimados (sen nocturnidade/hex/IT)
  const totalDevengos = salarioMensual_tabla + linealMensual_tabla + complementoAntMensual;

  // mostrar resumo
  let html = `<h3>Resumo (uso forzado das táboas do convenio)</h3>`;
  html += `<p class="small"><strong>Antigüidade:</strong> ${antig.toString()}</p>`;
  html += `<p class="small"><strong>Trienios aplicados:</strong> ${compAnt.trienios} — <strong>Quinquenios aplicados:</strong> ${compAnt.quinquenios}</p>`;
  html += `<p class="small"><strong>Unidades (3% cada unha):</strong> ${compAnt.unidades} → <strong>% total aplicado:</strong> ${(compAnt.totalPercent*100).toFixed(2)}%</p>`;
  html += `<hr>`;
  html += `<p class="small"><strong>Salario base anual (táboa):</strong> ${compAnt.salarioBaseAnual.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Complemento ex‑categoría anual (táboa):</strong> ${compAnt.complementoExCategoriaAnual.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Módulo anual (táboa):</strong> ${compAnt.moduloAnual.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Módulo mensual:</strong> ${compAnt.moduloMensual.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Importe anual do complemento de antigüidade:</strong> ${compAnt.importeAnualAplicado.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Importe mensual do complemento de antigüidade:</strong> ${compAnt.importeMensualAplicado.toFixed(2)} €</p>`;
  html += `<hr>`;
  html += `<p class="small"><strong>Salario base mensual (táboa):</strong> ${salarioMensual_tabla.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Complemento lineal mensual (táboa):</strong> ${linealMensual_tabla.toFixed(2)} €</p>`;
  html += `<p class="small"><strong>Total devengos estimados (sen nocturnidade/hex/IT):</strong> ${totalDevengos.toFixed(2)} €</p>`;
  html += `<p class="small">Fonte do módulo: <strong>Táboas do convenio (forzado)</strong> — art. 7.3.5 aplicado.</p>`;

  resumoEl.innerHTML = html;
});
</script>
</body>
</html>
